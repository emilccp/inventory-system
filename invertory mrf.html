<!DOCTYPE html>
<!-- Chosen Palette: Professional Blue & Slate -->
<!-- Application Structure Plan: The application is structured around a task-oriented user flow focused on core actions. The default view is the "Stock In/Out" form for direct data entry. Users can easily navigate to other key tasks: "Material Request", viewing the "Log" of all activities, and "Admin" for management. This simple, direct structure prioritizes operational efficiency. -->
<!-- Visualization & Content Choices: The focus is on clear forms and lists. Data is presented in dynamically generated HTML cards within the Log, providing detailed, readable records. No complex charts are needed for this core operational view. Admin controls are conditionally rendered based on login state. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory & Material Request System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        h1, h2, h3 { font-family: 'Poppins', sans-serif; }
        .main-container { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02); }
        input[type="file"] { display: none; }
        .loader { border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #ffffff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        :root { --theme-primary: #3b82f6; --theme-primary-hover: #2563eb; --theme-green: #10b981; --theme-orange: #f97316; --theme-red: #ef4444; }
        .tab-btn { border-bottom: 3px solid transparent; transition: all 0.3s ease-in-out; padding: 0.75rem 0.5rem; font-size: 0.875rem; font-weight: 500; color: #4b5563; }
        .tab-btn:hover { background-color: #f9fafb; }
        .tab-btn.active { border-color: var(--theme-primary); color: var(--theme-primary); font-weight: 600; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--theme-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--theme-primary-hover); }
        .btn-green { background-color: var(--theme-green); color: white; }
        .btn-green:hover:not(:disabled) { background-color: #059669; }
        .image-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem; border: 2px solid #e5e7eb; cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .image-thumbnail:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .notification-badge { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; border-radius: 50%; background-color: var(--theme-red); color: white; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
        #language-switcher button { padding: 4px 10px; font-size: 14px; border: 1px solid #d1d5db; background-color: #ffffff; border-radius: 8px; margin-right: 6px; transition: all 0.2s ease; font-weight: 500; }
        #language-switcher button.active { background-color: var(--theme-primary); color: white; border-color: var(--theme-primary); font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        #language-switcher button:not(.active):hover { background-color: #f9fafb; border-color: #a5b4fc; }
        .form-input { display: block; width: 100%; border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; background-color: #f9fafb; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus { outline: none; border-color: var(--theme-primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .radio-card { border: 2px solid #e5e7eb; transition: all 0.2s ease-in-out; }
        .peer[value="outbound"]:checked + .radio-card { border-color: var(--theme-orange); background-color: #fff7ed; }
        .peer[value="outbound"]:checked + .radio-card .radio-card-icon, .peer[value="outbound"]:checked + .radio-card .radio-card-text { color: var(--theme-orange); }
        .peer[value="inbound"]:checked + .radio-card { border-color: var(--theme-green); background-color: #ecfdf5; }
        .peer[value="inbound"]:checked + .radio-card .radio-card-icon, .peer[value="inbound"]:checked + .radio-card .radio-card-text { color: var(--theme-green); }
        .log-card { transition: transform 0.2s, box-shadow 0.2s; }
        .log-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .modal .transform { transition: all 0.2s ease-out; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        <header class="text-center mb-8 relative">
            <div id="language-switcher" class="absolute top-0 left-0 z-10"></div>
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-gray-800 pt-12"></h1>
            <p id="company-name" class="text-gray-500 mt-2 font-medium tracking-wide">Airnovation Engineering Pte Ltd</p>
        </header>

        <div class="bg-white rounded-xl main-container">
            <div class="grid grid-cols-2 sm:grid-cols-4 border-b border-gray-200 px-4">
                <button data-tab="form" id="tab-form" class="tab-btn"></button>
                <button data-tab="request" id="tab-request" class="tab-btn"></button>
                <button data-tab="logs" id="tab-logs" class="tab-btn"></button>
                <button data-tab="admin" id="tab-admin" class="tab-btn relative">
                    <span class="admin-button-text"></span>
                    <span id="request-notification-badge" class="notification-badge hidden"></span>
                </button>
            </div>
            <div id="app-content" class="min-h-[400px]"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="notification-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 text-center transform scale-95 opacity-0">
            <p id="notification-message" class="text-lg text-gray-800"></p>
            <button id="notification-ok-btn" onclick="hideModal('notification-modal')" class="mt-6 w-full btn btn-primary"></button>
        </div>
    </div>
    <div id="password-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-8 transform scale-95 opacity-0">
            <h3 id="password-title" class="text-xl font-bold mb-4 text-gray-800 text-center"></h3>
            <input type="password" id="password-input" class="form-input text-center text-lg tracking-widest">
            <p id="password-error" class="text-red-500 text-sm mt-2 text-center hidden"></p>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="password-cancel" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300"></button>
                <button id="password-submit" class="btn btn-primary"></button>
            </div>
        </div>
    </div>
    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 text-center transform scale-95 opacity-0">
             <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <span class="material-icons-outlined text-red-600">warning</span>
            </div>
            <p id="delete-confirm-message" class="text-lg text-gray-700 mt-4"></p>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="delete-cancel-btn" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300"></button>
                <button id="delete-confirm-btn" class="btn bg-red-600 text-white hover:bg-red-700"></button>
            </div>
        </div>
    </div>
    <div id="image-lightbox-modal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 hidden z-[60] cursor-pointer" onclick="hideModal('image-lightbox-modal')">
        <img id="lightbox-image" src="" alt="Full size image view" class="rounded-lg shadow-2xl">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const translations = {
            en: {
                title: "Inventory & Material Request", tab_form: "Stock In/Out", tab_request: "Material Request", tab_logs: "Log", tab_admin_login: "Admin Login", tab_admin_logout: "Logout", action_type: "Action Type", outbound: "Outbound", inbound: "Inbound", fill_details: "Fill Details", item_name: "Item Name", quantity: "Quantity", dept_pic: "Dept./PIC", location: "Location", photo_optional: "Photo (Optional)", upload_image: "Upload Image", submit: "Submit", request_form_title: "Material Request Form", pic_name: "PIC Name", used_for: "Used For", material_name: "Material Name", date_needed: "Date Needed (Optional)", delivery_address: "Delivery Address", submit_request: "Submit Request", activity_log: "Activity Log", no_records: "No Records Found", request_mgmt: "Material Request Management", no_requests: "No Pending Requests", ok: "OK", password_title: "Admin Password", password_error: "Wrong Password.", cancel: "Cancel", confirm: "Confirm", delete_confirm_msg: "Are you sure you want to delete this item?", delete: "Delete", by: "By:", loc: "Location:", img: "Image:", status_new: "New", status_processing: "Processing", status_completed: "Completed", qty: "Qty:", for: "For:", to: "To:", date_needed_label: "Date Needed:", eta_label: "ETA:", process: "Process", complete: "Complete",
                notify_record_submitted: "Record submitted successfully!", notify_submission_failed: "Submission failed.", notify_request_submitted: "Request submitted successfully!", notify_admin_logout: "Logged out from admin mode.", notify_admin_login: "Admin mode enabled.", notify_item_deleted: "Item deleted.", notify_delete_failed: "Deletion failed.", notify_update_failed: "Update failed.", notify_eta_update_failed: "ETA update failed."
            },
            zh: {
                title: "库存与物料申请", tab_form: "出入库", tab_request: "物料申请", tab_logs: "日志", tab_admin_login: "管理员登录", tab_admin_logout: "登出", action_type: "操作类型", outbound: "出库", inbound: "入库", fill_details: "填写信息", item_name: "物品名称", quantity: "数量", dept_pic: "部门/负责人", location: "地点", photo_optional: "照片 (可选)", upload_image: "上传图片", submit: "提交", request_form_title: "物料申请表", pic_name: "负责人名字", used_for: "用途", material_name: "材料名称", date_needed: "期望日期 (可选)", delivery_address: "送货地址", submit_request: "提交申请", activity_log: "操作日志", no_records: "没有记录", request_mgmt: "物料申请管理", no_requests: "没有申请", ok: "好的", password_title: "管理员密码", password_error: "密码错误。", cancel: "取消", confirm: "确认", delete_confirm_msg: "确定要删除这条记录吗?", delete: "删除", by: "负责人:", loc: "地点:", img: "图片:", status_new: "新申请", status_processing: "处理中", status_completed: "已完成", qty: "数量:", for: "用途:", to: "送至:", date_needed_label: "期望日期:", eta_label: "预计到达:", process: "处理", complete: "完成",
                notify_record_submitted: "记录提交成功！", notify_submission_failed: "提交失败。", notify_request_submitted: "申请提交成功！", notify_admin_logout: "已退出管理员模式。", notify_admin_login: "已进入管理员模式。", notify_item_deleted: "记录已删除。", notify_delete_failed: "删除失败。", notify_update_failed: "更新失败。", notify_eta_update_failed: "预计到达日期更新失败。"
            },
            ta: {
                title: "சரக்கு & பொருள் கோரிக்கை", tab_form: "கையிருப்பு உள்ளே/வெளியே", tab_request: "பொருள் கோரிக்கை", tab_logs: "பதிவு", tab_admin_login: "நிர்வாகி உள்நுழைவு", tab_admin_logout: "வெளியேறு", action_type: "செயல் வகை", outbound: "வெளிச்செல்லும்", inbound: "உள்வரும்", fill_details: "விவரங்களை நிரப்பவும்", item_name: "பொருள் பெயர்", quantity: "அளவு", dept_pic: "துறை/பொறுப்பாளர்", location: "இடம்", photo_optional: "புகைப்படம் (விருப்பத்தேர்வு)", upload_image: "படத்தைப் பதிவேற்றவும்", submit: "சமர்ப்பிக்கவும்", request_form_title: "பொருள் கோரிக்கை படிவம்", pic_name: "பொறுப்பாளர் பெயர்", used_for: "பயன்பாடு", material_name: "பொருள் பெயர்", date_needed: "தேவைப்படும் தேதி (விருப்பத்தேர்வு)", delivery_address: "விநியோக முகவரி", submit_request: "கோரிக்கையைச் சமர்ப்பிக்கவும்", activity_log: "செயல்பாட்டு பதிவு", no_records: "பதிவுகள் இல்லை", request_mgmt: "பொருள் கோரிக்கை மேலாண்மை", no_requests: "கோரிக்கைகள் இல்லை", ok: "சரி", password_title: "நிர்வாகி கடவுச்சொல்", password_error: "தவறான கடவுச்சொல்.", cancel: "ரத்துசெய்", confirm: "உறுதிப்படுத்தவும்", delete_confirm_msg: "இந்த உருப்படியை நீக்க விரும்புகிறீர்களா?", delete: "நீக்கு", by: "அனுப்புநர்:", loc: "இடம்:", img: "படம்:", status_new: "புதியது", status_processing: "செயலாக்கத்தில்", status_completed: "முடிந்தது", qty: "அளவு:", for: "இதற்காக:", to: "பெறுநர்:", date_needed_label: "தேவைப்படும் தேதி:", eta_label: "ETA:", process: "செயலாக்கு", complete: "முடி",
                notify_record_submitted: "பதிவு வெற்றிகரமாக சமர்ப்பிக்கப்பட்டது!", notify_submission_failed: "சமர்ப்பிப்பு தோல்வியடைந்தது.", notify_request_submitted: "கோரிக்கை வெற்றிகரமாக சமர்ப்பிக்கப்பட்டது!", notify_admin_logout: "நிர்வாகி பயன்முறையிலிருந்து வெளியேறப்பட்டது.", notify_admin_login: "நிர்வாகி பயன்முறை இயக்கப்பட்டது.", notify_item_deleted: "உருப்படி நீக்கப்பட்டது.", notify_delete_failed: "நீக்குதல் தோல்வியடைந்தது.", notify_update_failed: "புதுப்பித்தல் தோல்வியடைந்தது.", notify_eta_update_failed: "ETA புதுப்பித்தல் தோல்வியடைந்தது."
            },
        };

        const firebaseConfig = {
            apiKey: "AIzaSyBZ0-KPzLs13U7uG0KIqiYbKdbOBqVT7cQ",
            authDomain: "airnovation-inventory.firebaseapp.com",
            projectId: "airnovation-inventory",
            storageBucket: "airnovation-inventory.firebasestorage.app",
            messagingSenderId: "273073947687",
            appId: "1:273073947687:web:2bd59cddbf675526747a02",
            measurementId: "G-MV1LH9X1DD"
        };
        
        let app, db, auth, userId, isAdmin = false, inventoryLogs = [], materialRequests = [], currentTab = 'form', currentLanguage = 'en';

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { console.error("Firebase Init Failed:", e); alert("System initialization failed."); }
        
        const setLanguage = (lang) => { currentLanguage = lang; renderAll(); document.querySelectorAll('#language-switcher button').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang)); };
        const t = (key) => translations[currentLanguage][key] || key;
        const showModal = (id) => { const el = document.getElementById(id); if(!el) return; el.classList.remove('hidden'); setTimeout(() => { const transformDiv = el.querySelector('.transform'); if(transformDiv) transformDiv.classList.remove('scale-95', 'opacity-0'); }, 10); };
        const hideModal = (id) => { const el = document.getElementById(id); if(!el) return; const transformDiv = el.querySelector('.transform'); if(transformDiv) transformDiv.classList.add('scale-95', 'opacity-0'); setTimeout(() => el.classList.add('hidden'), 200); };
        window.hideModal = hideModal;
        const showNotification = (key) => { const msgEl = document.getElementById('notification-message'); const okBtn = document.getElementById('notification-ok-btn'); if(msgEl) msgEl.textContent = t(key); if(okBtn) okBtn.textContent = t('ok'); showModal('notification-modal'); };
        const formatTimestamp = (ts) => ts ? ts.toDate().toLocaleString('en-SG', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'Unknown';
        const resizeImage = (base64, maxW = 800, maxH = 800) => new Promise(res => {
            const img = new Image();
            img.src = base64;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let { width, height } = img;
                if (width > height) {
                    if (width > maxW) { height *= maxW / width; width = maxW; }
                } else {
                    if (height > maxH) { width *= maxH / height; height = maxH; }
                }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                res(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.onerror = () => res(null);
        });
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                if (!db) return;
                const appId = "inventory-tracker-app-dev";
                onSnapshot(query(collection(db, `artifacts/${appId}/public/data/inventory_logs`)), snap => { inventoryLogs = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); });
                onSnapshot(query(collection(db, `artifacts/${appId}/public/data/material_requests`)), snap => { materialRequests = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); });
            } else {
                try { const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; if (token) await signInWithCustomToken(auth, token); else await signInAnonymously(auth); } 
                catch (e) { console.error("Auth Error:", e); showNotification("Cannot connect to service."); }
            }
        });

        const TEMPLATES = {
            form: () => `<form id="inventory-form" class="p-6 md:p-8 space-y-8"><div><label class="block text-base font-semibold text-gray-800 mb-3">${t('action_type')}</label><div class="grid grid-cols-2 gap-4"><label><input type="radio" name="action_type" value="outbound" class="sr-only peer"><div class="p-4 flex flex-col items-center justify-center text-gray-600 bg-white rounded-lg radio-card cursor-pointer"><span class="material-icons-outlined text-3xl radio-card-icon outbound">file_upload</span><p class="font-semibold mt-2 radio-card-text">${t('outbound')}</p></div></label><label><input type="radio" name="action_type" value="inbound" class="sr-only peer" checked><div class="p-4 flex flex-col items-center justify-center text-gray-600 bg-white rounded-lg radio-card cursor-pointer"><span class="material-icons-outlined text-3xl radio-card-icon inbound">file_download</span><p class="font-semibold mt-2 radio-card-text">${t('inbound')}</p></div></label></div></div><div><label class="block text-base font-semibold text-gray-800 mb-3">${t('fill_details')}</label><div class="space-y-4"><div><label for="item-name" class="block text-sm font-medium text-gray-600 mb-1">${t('item_name')} <span class="text-red-500">*</span></label><input type="text" id="item-name" required class="form-input"></div><div><label for="quantity" class="block text-sm font-medium text-gray-600 mb-1">${t('quantity')} <span class="text-red-500">*</span></label><input type="number" id="quantity" required class="form-input"></div><div><label for="department-head" class="block text-sm font-medium text-gray-600 mb-1">${t('dept_pic')} <span class="text-red-500">*</span></label><input type="text" id="department-head" required class="form-input"></div><div><label for="location" class="block text-sm font-medium text-gray-600 mb-1">${t('location')}</label><input type="text" id="location" class="form-input"></div><div class="pt-2"><label class="block text-sm font-medium text-gray-600 mb-2">${t('photo_optional')}</label><label for="logging-item-photo" class="w-full flex items-center justify-center px-4 py-6 bg-gray-50 text-gray-500 rounded-lg border-2 border-dashed border-gray-300 cursor-pointer hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 transition-colors"><span class="material-icons-outlined text-3xl">add_a_photo</span><span id="logging-photo-label" class="ml-3 text-base">${t('upload_image')}</span></label><input type="file" id="logging-item-photo" accept="image/*" capture="environment"><img id="logging-photo-preview" class="mt-4 rounded-lg hidden image-thumbnail" alt="Logging Photo Preview"/></div></div></div><button type="submit" class="w-full btn btn-primary"><span>${t('submit')}</span><div class="loader hidden ml-3"></div></button></form>`,
            request: () => `<form id="material-request-form" class="p-6 md:p-8"><h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">${t('request_form_title')}</h2><div class="space-y-4"><div><label for="request-person-in-charge" class="block text-sm font-medium text-gray-600 mb-1">${t('pic_name')} <span class="text-red-500">*</span></label><input type="text" id="request-person-in-charge" required class="form-input"></div><div><label for="request-purpose" class="block text-sm font-medium text-gray-600 mb-1">${t('used_for')} <span class="text-red-500">*</span></label><input type="text" id="request-purpose" required class="form-input"></div><div><label for="request-material-name" class="block text-sm font-medium text-gray-600 mb-1">${t('material_name')} <span class="text-red-500">*</span></label><input type="text" id="request-material-name" required class="form-input"></div><div><label for="request-quantity" class="block text-sm font-medium text-gray-600 mb-1">${t('quantity')} <span class="text-red-500">*</span></label><input type="number" id="request-quantity" required class="form-input"></div><div><label for="request-date-needed" class="block text-sm font-medium text-gray-600 mb-1">${t('date_needed')}</label><input type="date" id="request-date-needed" class="form-input"></div><div><label for="request-delivery-address" class="block text-sm font-medium text-gray-600 mb-1">${t('delivery_address')} <span class="text-red-500">*</span></label><input type="text" id="request-delivery-address" required class="form-input"></div><div class="pt-2"><label class="block text-sm font-medium text-gray-600 mb-2">${t('photo_optional')}</label><label for="request-item-photo" class="w-full flex items-center justify-center px-4 py-6 bg-gray-50 text-gray-500 rounded-lg border-2 border-dashed border-gray-300 cursor-pointer hover:bg-green-50 hover:border-green-500 hover:text-green-600 transition-colors"><span class="material-icons-outlined text-3xl">add_a_photo</span><span id="request-photo-label" class="ml-3 text-base">${t('upload_image')}</span></label><input type="file" id="request-item-photo" accept="image/*" capture="environment"><img id="request-photo-preview" class="mt-4 rounded-lg hidden image-thumbnail" alt="Request Photo Preview"/></div></div><button type="submit" class="w-full btn btn-green mt-8"><span>${t('submit_request')}</span><div class="loader hidden ml-3"></div></button></form>`,
            logs: () => `<div class="p-4 md:p-6"><h2 class="text-2xl font-bold text-gray-800 mb-4 px-2">${t('activity_log')}</h2><div id="log-container" class="space-y-3"></div></div>`,
            admin: () => `<div class="p-4 md:p-6"><h2 class="text-2xl font-bold text-gray-800 mb-4 px-2">${t('request_mgmt')}</h2><div id="request-log-container" class="space-y-3"></div></div>`,
        };
        
        function renderStaticText() {
            document.getElementById('main-title').textContent = t('title');
            document.getElementById('tab-form').textContent = t('tab_form');
            document.getElementById('tab-request').textContent = t('tab_request');
            document.getElementById('tab-logs').textContent = t('tab_logs');
            document.querySelector('#tab-admin .admin-button-text').textContent = isAdmin ? t('tab_admin_logout') : t('tab_admin_login');
        }

        function renderAll() {
            if (!document.getElementById('app-content')) return;
            renderStaticText();
            const container = document.getElementById('app-content');
            container.innerHTML = TEMPLATES[currentTab] ? TEMPLATES[currentTab]() : '';

            if (currentTab === 'logs') renderLogs();
            if (currentTab === 'admin') renderAdmin();
            
            const newRequestCount = materialRequests.filter(req => req.status === 'new').length;
            const badge = document.getElementById('request-notification-badge');
            badge.textContent = newRequestCount;
            badge.classList.toggle('hidden', newRequestCount === 0 || isAdmin);
        }

        function renderLogs() {
            const logContainer = document.getElementById('log-container');
            if(!logContainer) return;
            logContainer.innerHTML = '';
            const combinedLogs = [...inventoryLogs, ...materialRequests].sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
            if (combinedLogs.length === 0) {
                logContainer.innerHTML = `<div class="text-center text-gray-500 py-16"><span class="material-icons-outlined text-5xl text-gray-400">inventory_2</span><p class="mt-4">${t('no_records')}</p></div>`;
            } else {
                combinedLogs.forEach(item => logContainer.appendChild(item.status ? createRequestCard(item) : createLogCard(item)));
            }
        }

        function renderAdmin() {
            const requestContainer = document.getElementById('request-log-container');
            if(!requestContainer) return;
            requestContainer.innerHTML = '';
            const pendingRequests = materialRequests.sort((a,b) => {
                const statusOrder = { 'new': 1, 'processing': 2, 'completed': 3 };
                return (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
            });
            if (pendingRequests.length === 0) {
                requestContainer.innerHTML = `<div class="text-center text-gray-500 py-16"><span class="material-icons-outlined text-5xl text-gray-400">task_alt</span><p class="mt-4">${t('no_requests')}</p></div>`;
            } else {
                pendingRequests.forEach(req => requestContainer.appendChild(createRequestCard(req)));
            }
        }

        function createLogCard(log) {
            const el = document.createElement('div');
            const isOutbound = log.type === 'outbound';
            const borderColor = isOutbound ? 'border-orange-400' : 'border-green-400';
            el.className = `p-4 rounded-lg shadow-sm bg-white border-l-4 ${borderColor} log-card`;
            const imgHTML = log.imageDataURL ? `<div class="mt-3"><img src="${log.imageDataURL}" class="image-thumbnail" alt="Log Image"></div>` : '';
            const adminDelete = isAdmin ? `<div class="mt-3 pt-3 border-t border-gray-100 text-right"><button data-id="${log.id}" data-type="log" class="delete-btn text-gray-400 hover:text-red-600 transition-colors"><span class="material-icons-outlined">delete</span></button></div>` : '';
            const icon = isOutbound ? `<span class="material-icons-outlined text-orange-500">file_upload</span>` : `<span class="material-icons-outlined text-green-500">file_download</span>`;
            el.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1"><p class="font-bold text-gray-800">${log.itemName}</p><p class="text-sm text-gray-500 mt-1">${t('by')} <strong class="text-gray-700">${log.departmentHead || 'N/A'}</strong></p><p class="text-sm text-gray-500">${t('loc')} <strong class="text-gray-700">${log.location || 'N/A'}</strong></p></div><div class="text-right ml-4 flex-shrink-0"><div class="flex items-center justify-end gap-2 font-semibold ${isOutbound ? 'text-orange-600' : 'text-green-600'}">${icon}<span>x ${log.quantity}</span></div><p class="text-xs text-gray-400 mt-1">${formatTimestamp(log.timestamp)}</p></div></div>${imgHTML}${adminDelete}`;
            return el;
        };
        
        function createRequestCard(req) {
            const el = document.createElement('div');
            el.className = 'p-4 rounded-lg shadow-sm bg-white border-l-4 border-blue-400 log-card';
            const getStatusBadgeHTML = (status) => {
                const statusMap = { 'new': { key: 'status_new', bg: 'bg-red-100 text-red-800', dot: 'bg-red-500' }, 'processing': { key: 'status_processing', bg: 'bg-yellow-100 text-yellow-800', dot: 'bg-yellow-500' }, 'completed': { key: 'status_completed', bg: 'bg-green-100 text-green-800', dot: 'bg-green-500' } };
                const s = statusMap[status] || {text: status, bg: 'bg-gray-100 text-gray-800', dot: 'bg-gray-500'};
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.bg}"><span class="w-2 h-2 mr-2 rounded-full ${s.dot}"></span>${t(s.key)}</span>`;
            }
            const getAdminControlsHTML = (id, req) => {
                if (!isAdmin) return '';
                const deleteBtn = `<button data-id="${id}" data-type="request" class="delete-btn text-gray-400 hover:text-red-600 transition-colors"><span class="material-icons-outlined">delete</span></button>`;
                if (req.status === 'new') return `<div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center"><button data-id="${id}" data-action="process" class="process-btn btn btn-primary text-sm py-1 px-3">${t('process')}</button>${deleteBtn}</div>`;
                if (req.status === 'processing') return `<div class="mt-3 pt-3 border-t border-gray-200 space-y-2"><div class="flex items-center gap-2 flex-wrap"><label class="text-xs font-medium whitespace-nowrap">${t('eta_label')}</label><input type="date" data-id="${id}" value="${req.arrivalDate || ''}" class="arrival-date-input p-1 border rounded text-sm w-full sm:w-auto form-input"><button data-id="${id}" data-action="complete" class="complete-btn btn btn-green text-sm py-1 px-3">${t('complete')}</button></div><div class="text-right">${deleteBtn}</div></div>`;
                return `<div class="mt-3 pt-3 border-t border-gray-200 text-right">${deleteBtn}</div>`;
            };
            const imgHTML = req.imageDataURL ? `<div class="mt-3"><img src="${req.imageDataURL}" class="image-thumbnail" alt="Material Image"></div>` : '';
            const etaHTML = req.status !== 'new' && req.arrivalDate ? `<p class="text-green-600 font-semibold text-sm">${t('eta_label')} ${req.arrivalDate}</p>` : '';
            el.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1"><p class="font-bold text-gray-800">${req.materialName}</p><p class="text-sm text-gray-500 mt-1">${t('by')} <strong class="text-gray-700">${req.personInCharge}</strong> | ${t('qty')} <strong class="text-gray-700">${req.quantity}</strong></p><p class="text-sm text-gray-500">${t('for')} <strong class="text-gray-700">${req.purpose}</strong></p></div><div class="text-right ml-4 flex-shrink-0">${getStatusBadgeHTML(req.status)}<p class="text-xs text-gray-400 mt-1">${formatTimestamp(req.timestamp)}</p></div></div><div class="mt-3 pt-3 border-t border-gray-100 text-sm space-y-1"><p><strong>${t('to')}</strong> ${req.deliveryAddress}</p><p><strong>${t('date_needed_label')}</strong> ${req.dateNeeded || 'N/A'}</p>${etaHTML}</div>${imgHTML}${getAdminControlsHTML(req.id, req)}`;
            return el;
        };

        const langSwitcher = document.getElementById('language-switcher');
        langSwitcher.innerHTML = `<button data-lang="en">EN</button><button data-lang="zh">中文</button><button data-lang="ta">தமிழ்</button>`;
        langSwitcher.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') setLanguage(e.target.dataset.lang); });
        
        document.addEventListener('click', async (e) => {
            const tabBtn = e.target.closest('.tab-btn');
            if (tabBtn) {
                const targetTab = tabBtn.dataset.tab;
                if (targetTab === 'admin') {
                    if(isAdmin) {
                        isAdmin = false;
                        showNotification('notify_admin_logout');
                        renderAll();
                    } else {
                        document.getElementById('password-title').textContent = t('password_title');
                        document.getElementById('password-error').textContent = t('password_error');
                        document.getElementById('password-cancel').textContent = t('cancel');
                        document.getElementById('password-submit').textContent = t('confirm');
                        document.getElementById('password-input').value = "";
                        document.getElementById('password-error').classList.add('hidden');
                        showModal('password-modal');
                        document.getElementById('password-input').focus();
                    }
                } else {
                    currentTab = targetTab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    tabBtn.classList.add('active');
                    renderAll();
                }
            }

            if (e.target.id === 'password-submit') {
                if (document.getElementById('password-input').value === 'aepl888') {
                    hideModal('password-modal');
                    isAdmin = true;
                    showNotification('notify_admin_login');
                    currentTab = 'admin';
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector('.tab-btn[data-tab="admin"]').classList.add('active');
                    renderAll();
                } else { document.getElementById('password-error').classList.remove('hidden'); }
            }
            if (e.target.id === 'password-cancel') { hideModal('password-modal'); }

            const submitBtn = e.target.closest('button[type="submit"]');
            if(submitBtn) {
                e.preventDefault();
                const form = submitBtn.closest('form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const loader = submitBtn.querySelector('.loader');
                loader.classList.remove('hidden');
                submitBtn.disabled = true;
                
                const appId = "inventory-tracker-app-dev";
                if (form.id === 'inventory-form') {
                    try {
                        const logData = { type: form.querySelector('[name="action_type"]:checked').value, itemName: form.querySelector('#item-name').value, quantity: parseInt(form.querySelector('#quantity').value, 10) || 0, departmentHead: form.querySelector('#department-head').value, location: form.querySelector('#location').value, timestamp: serverTimestamp(), submitterId: userId };
                        const preview = form.querySelector('#logging-photo-preview');
                        if (preview.src && preview.src.startsWith('data:image')) { logData.imageDataURL = await resizeImage(preview.src); }
                        await addDoc(collection(db, `artifacts/${appId}/public/data/inventory_logs`), logData);
                        showNotification('notify_record_submitted');
                        form.reset();
                        const loggingPhotoPreview = form.querySelector('#logging-photo-preview');
                        if (loggingPhotoPreview) {
                            loggingPhotoPreview.classList.add('hidden');
                            loggingPhotoPreview.src = "";
                        }
                        const loggingPhotoLabel = form.querySelector('#logging-photo-label');
                        if(loggingPhotoLabel) loggingPhotoLabel.textContent = t('upload_image');

                    } catch (error) {
                        console.error("Log submission failed:", error);
                        showNotification('notify_submission_failed');
                    } finally {
                        loader.classList.add('hidden');
                        submitBtn.disabled = false;
                    }
                } else if (form.id === 'material-request-form') {
                    try {
                        const requestData = { personInCharge: form.querySelector('#request-person-in-charge').value, purpose: form.querySelector('#request-purpose').value, materialName: form.querySelector('#request-material-name').value, quantity: parseInt(form.querySelector('#request-quantity').value, 10) || 0, dateNeeded: form.querySelector('#request-date-needed').value, deliveryAddress: form.querySelector('#request-delivery-address').value, status: 'new', timestamp: serverTimestamp(), submitterId: userId };
                        const preview = form.querySelector('#request-photo-preview');
                        if (preview.src && preview.src.startsWith('data:image')) { requestData.imageDataURL = await resizeImage(preview.src); }
                        await addDoc(collection(db, `artifacts/${appId}/public/data/material_requests`), requestData);
                        showNotification('notify_request_submitted');
                        form.reset();
                        const requestPhotoPreview = form.querySelector('#request-photo-preview');
                        if (requestPhotoPreview) {
                           requestPhotoPreview.classList.add('hidden');
                           requestPhotoPreview.src = "";
                        }
                        const requestPhotoLabel = form.querySelector('#request-photo-label');
                        if(requestPhotoLabel) requestPhotoLabel.textContent = t('upload_image');

                    } catch (error) {
                        console.error("Request submission failed:", error);
                        showNotification('notify_submission_failed');
                    } finally {
                        loader.classList.add('hidden');
                        submitBtn.disabled = false;
                    }
                }
            }

            if (e.target.closest('.delete-btn')) {
                const btn = e.target.closest('.delete-btn');
                const { id, type } = btn.dataset;
                document.getElementById('delete-confirm-message').textContent = t('delete_confirm_msg');
                document.getElementById('delete-cancel-btn').textContent = t('cancel');
                document.getElementById('delete-confirm-btn').textContent = t('delete');
                const modal = document.getElementById('delete-confirm-modal');
                modal.dataset.docId = id; modal.dataset.type = type;
                showModal('delete-confirm-modal');
            }
            if (e.target.id === 'delete-confirm-btn') {
                const modal = document.getElementById('delete-confirm-modal');
                const { docId, type } = modal.dataset;
                const collectionName = type === 'log' ? 'inventory_logs' : 'material_requests';
                const appId = "inventory-tracker-app-dev";
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId));
                    showNotification('notify_item_deleted');
                } catch(err) { console.error("Deletion failed: ", err); showNotification('notify_delete_failed'); }
                hideModal('delete-confirm-modal');
            }
            if (e.target.id === 'delete-cancel-btn') { hideModal('delete-confirm-modal'); }

            if (e.target.classList.contains('image-thumbnail')) {
                document.getElementById('lightbox-image').src = e.target.src;
                showModal('image-lightbox-modal');
            }

            const adminActionBtn = e.target.closest('.process-btn, .complete-btn');
            if (adminActionBtn) {
                const { id, action } = adminActionBtn.dataset;
                const appId = "inventory-tracker-app-dev";
                const docRef = doc(db, `artifacts/${appId}/public/data/material_requests`, id);
                try {
                    if (action === 'process') await updateDoc(docRef, { status: 'processing' });
                    else if (action === 'complete') await updateDoc(docRef, { status: 'completed' });
                } catch(err) { console.error("Update failed: ", err); showNotification('notify_update_failed'); }
            }
        });

        document.addEventListener('change', async (e) => {
            if (e.target.classList.contains('arrival-date-input')) {
                try {
                     const appId = "inventory-tracker-app-dev";
                     await updateDoc(doc(db, `artifacts/${appId}/public/data/material_requests`, e.target.dataset.id), { arrivalDate: e.target.value });
                } catch(err) { console.error("ETA update failed: ", err); showNotification('notify_eta_update_failed'); }
            }

            const photoInputId = e.target.id;
            if (photoInputId === 'request-item-photo' || photoInputId === 'logging-item-photo') {
                const previewId = photoInputId.replace('item-photo', 'photo-preview');
                const labelId = photoInputId.replace('item-photo', 'photo-label');
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = re => {
                        const previewEl = document.getElementById(previewId);
                        if(previewEl) {
                           previewEl.src = re.target.result;
                           previewEl.classList.remove('hidden');
                        }
                    };
                    reader.readAsDataURL(file);
                    const labelEl = document.getElementById(labelId);
                    if(labelEl) {
                       labelEl.textContent = file.name.length > 20 ? `${file.name.substring(0, 17)}...` : file.name;
                    }
                }
            }
        });
        
        setLanguage(currentLanguage);
        document.querySelector('.tab-btn[data-tab="form"]').classList.add('active');
        renderAll();
    </script>
</body>
</html>
